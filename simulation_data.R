library(readr)
library(dplyr)
library(plyr)
library(spatstat)
library(tidyr)
library(data.table)
devtools::install_github("amd112/rseiAnalysis")
library("rseiAnalysis")
set.seed(4012)

t1990 = as.data.frame(fread("data/toxic/tract/toxic_1990_2010_tract.csv", data.table = FALSE))
t1991 = as.data.frame(fread("data/toxic/tract/toxic_1991_2010_tract.csv", data.table = FALSE))
t1992 = as.data.frame(fread("data/toxic/tract/toxic_1992_2010_tract.csv", data.table = FALSE))
t1993 = as.data.frame(fread("data/toxic/tract/toxic_1993_2010_tract.csv", data.table = FALSE))
t1994 = as.data.frame(fread("data/toxic/tract/toxic_1994_2010_tract.csv", data.table = FALSE))
#t1995 = as.data.frame(fread("data/toxic/tract/toxic_1995_2010_tract.csv", data.table = FALSE))
t1996 = as.data.frame(fread("data/toxic/tract/toxic_1996_2010_tract.csv", data.table = FALSE))
t1997 = as.data.frame(fread("data/toxic/tract/toxic_1997_2010_tract.csv", data.table = FALSE))
t1998 = as.data.frame(fread("data/toxic/tract/toxic_1998_2010_tract.csv", data.table = FALSE))
t1999 = as.data.frame(fread("data/toxic/tract/toxic_1999_2010_tract.csv", data.table = FALSE))
t2000 = as.data.frame(fread("data/toxic/tract/toxic_2000_2010_tract.csv", data.table = FALSE))
t2001 = as.data.frame(fread("data/toxic/tract/toxic_2001_2010_tract.csv", data.table = FALSE))
t2002 = as.data.frame(fread("data/toxic/tract/toxic_2002_2010_tract.csv", data.table = FALSE))
t2003 = as.data.frame(fread("data/toxic/tract/toxic_2003_2010_tract.csv", data.table = FALSE))
#t2004 = as.data.frame(fread("data/toxic/tract/toxic_2004_2010_tract.csv", data.table = FALSE))
t2005 = as.data.frame(fread("data/toxic/tract/toxic_2005_2010_tract.csv", data.table = FALSE))
t2006 = as.data.frame(fread("data/toxic/tract/toxic_2006_2010_tract.csv", data.table = FALSE))
t2007 = as.data.frame(fread("data/toxic/tract/toxic_2007_2010_tract.csv", data.table = FALSE))
t2008 = as.data.frame(fread("data/toxic/tract/toxic_2008_2010_tract.csv", data.table = FALSE))
t2009 = as.data.frame(fread("data/toxic/tract/toxic_2009_2010_tract.csv", data.table = FALSE))
t2010 = as.data.frame(fread("data/toxic/tract/toxic_2010_2010_tract.csv", data.table = FALSE))
t2011 = as.data.frame(fread("data/toxic/tract/toxic_2011_2010_tract.csv", data.table = FALSE))
t2012 = as.data.frame(fread("data/toxic/tract/toxic_2012_2010_tract.csv", data.table = FALSE))
t2013 = as.data.frame(fread("data/toxic/tract/toxic_2013_2010_tract.csv", data.table = FALSE))
t2014 = as.data.frame(fread("data/toxic/tract/toxic_2014_2010_tract.csv", data.table = FALSE))

read_in = function(year, tox) {
  data = as.data.frame(fread(paste0("data/census/hisp/hisp_tract_", year, ".csv"), data.table = FALSE))
  data = data[complete.cases(data), ]
  data$other_sum = rowSums(data[, 5:7])
  data = select(data, id, pop, white, black, hispanic, other_sum)
  names(data) = c("id", "pop", "white", "black", "hispanic", "other")
  data$id = str_pad(data$id, 11, pad = "0", side = "left")
  data = merge(data, tox, by.x = "id", by.y = "block")
  data$year = year
  return(data)
}

h1990 = read_in(1990, t1990)
h1991 = read_in(1991, t1991)
h1992 = read_in(1992, t1992)
h1993 = read_in(1993, t1993)
h1994 = read_in(1994, t1994)
#h1995 = read_in(1995, t1995)
h1996 = read_in(1996, t1996)
h1997 = read_in(1997, t1997)
h1998 = read_in(1998, t1998)
h1999 = read_in(1999, t1999)
h2000 = read_in(2000, t2000)
h2001 = read_in(2001, t2001)
h2002 = read_in(2002, t2002)
h2003 = read_in(2003, t2003)
#h2004 = read_in(2004, t2004)
h2005 = read_in(2005, t2005)
h2006 = read_in(2006, t2006)
h2007 = read_in(2007, t2007)
h2008 = read_in(2008, t2008)
h2009 = read_in(2009, t2009)
h2010 = read_in(2010, t2010)
h2011 = read_in(2011, t2011)
h2012 = read_in(2012, t2012)
h2013 = read_in(2013, t2013)

race_data = rbind.fill(h1990, h1991, h1992, h1993, h1994, h1996, h1997, h1998, h1999, h2000, h2001, h2002, 
                       h2003, h2005, h2006, h2007, h2008, h2009, h2010, h2011, h2012, h2013)

years = c(1990, 1991, 1992, 1993, 1994, 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2005, 2006, 2007, 
          2008, 2009, 2010, 2011, 2012, 2013)
l = length(years)

simulation05 = data.frame(year = rep(NA, l), sim_b = rep(NA, l), sim_a = rep(NA, l), sim_n = rep(NA, l), sim_o = rep(NA, l))
simulation50 = data.frame(year = rep(NA, l), sim_b = rep(NA, l), sim_a = rep(NA, l), sim_n = rep(NA, l), sim_o = rep(NA, l))
simulation95 = data.frame(year = rep(NA, l), sim_b = rep(NA, l), sim_a = rep(NA, l), sim_n = rep(NA, l), sim_o = rep(NA, l))

for (i in 1:length(years)){
  year = years[i]
  sim_b = extrapolate(race_data[race_data$year == year, ], race_data[race_data$year == 1990, ], "black", n = 100000)
  sim_o = extrapolate(race_data[race_data$year == year, ], race_data[race_data$year == 1990, ], "other", n = 100000)
  sim_h = extrapolate(race_data[race_data$year == year, ], race_data[race_data$year == 1990, ], "hispanic", n = 100000)
  simulation05$sim_b[i] = quantile(sim_b, 0.05)
  simulation50$sim_b[i] = quantile(sim_b, 0.50)
  simulation95$sim_b[i] = quantile(sim_b, 0.95)
  simulation05$sim_o[i] = quantile(sim_o, 0.05)
  simulation50$sim_o[i] = quantile(sim_o, 0.50)
  simulation95$sim_o[i] = quantile(sim_o, 0.95)
  simulation05$sim_h[i] = quantile(sim_h, 0.05)
  simulation50$sim_h[i] = quantile(sim_h, 0.50)
  simulation95$sim_h[i] = quantile(sim_h, 0.95)
}

write.csv(simulation05, "data/simulation05.csv", row.names = FALSE)
write.csv(simulation50, "data/simulation50.csv", row.names = FALSE)
write.csv(simulation95, "data/simulation95.csv", row.names = FALSE)