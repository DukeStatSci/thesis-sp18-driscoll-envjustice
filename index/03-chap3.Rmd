```{r, include = FALSE}
library(magrittr)
library(readr)
library(ggplot2)
library(dplyr)
library(plyr)
library(spatstat)
library(choroplethrMaps)
library(choroplethr)
library(tidyr)
library(devtools)
devtools::install_github("amd112/rseiAnalysis")
library("rseiAnalysis")
#needed for RSEI
library(plyr)
```

# Approaches and Methods {#ref-labels}

## Level of Analysis

The questions we would like to pose - how the distributions of toxicity that individuals experience over time are predicted by their complex, multidimensional identities - is inherently intended to be a person level analysis. That intent may not be achievable given the available data. 

This analysis depends on two data sources, the disaggregated RSEI toxic release data as compiled to contain only releases that are consistently reported between 1990 and 2010, as well as relevant demographic information from the census. 

RSEI environmental data can be obtained at extremely fine level (the 800 meter grid across the United States,) but the finest grain Census data is available at is the block level, which contains between 0 and a few hundred people. At such low geographic levels, few variables are available for demographics due to identifiability concerns. Additionally, few cross tabulations are available, due to concerns of identifiability. Using a low level of geography (like census blocks or block groups) is important for the environmental aspect of this analysis, since environmental hazards can be very localized, especially along neighborhood lines in urban areas. 

Unfortunately, the availability of cross tabulations is equally important to the goal of this work in examining inequality of environmental burden held by minority groups in America. The intersection of social identies, especially those steeped in systems of oppression, is extremely important for identifying unequal burdens. For example, low income populations across the board may be more likely to experience environmental hazards, but low income minority populations could be much more likely than low income white populations to experience extreme hazard. The intersections of demographic charictersitics, such as race and income or race and education are likely to be important in teasing out differences true inequality burden. 

To combine the data, we assign the aggregated releases to their respective geographies. For each census geography, we also have estimates of number of various population groups. From there, we move to a person level analysis by assigning each of the people the toxicity for the geography they originated in. By assigning each person the toxicity of their block group, we can aggregate nationally to find the distribution of toxicity that each group experiences. This approach is restricted in ability to approach the problem in an intersectional manner, since we can only build a distribution for each of the crosstabs we have available. For higher levels of geography (where we might, for example, have race by income) we would be able to build national distributions for each income by race group.

```{r, echo = FALSE}
#import toxicity data
bg2010 = read_csv("data/toxic_2010_2010_blockgroup.csv")

#import census data
census_bg = read_csv("data/ecologicalFallacy/census_bg_race.csv", skip = 1)
census_tract = read_csv("data/ecologicalFallacy/census_tract_race.csv", skip = 1)
census_county = read_csv("data/ecologicalFallacy/census_county_race.csv", skip = 1)
census_state = read_csv("data/ecologicalFallacy/census_state_race.csv", skip = 1)

#munge census data
census_bg = select(census_bg, Geo_FIPS, SE_T013_001, SE_T013_002, SE_T013_003)
names(census_bg)  = c("fips", "total", "white", "black")
census_tract = select(census_tract, Geo_FIPS, SE_T013_001, SE_T013_002, SE_T013_003)
names(census_tract)  = c("fips", "total", "white", "black")
census_county = select(census_county, Geo_FIPS, SE_T013_001, SE_T013_002, SE_T013_003)
names(census_county)  = c("fips", "total", "white", "black")
census_state = select(census_state, Geo_FIPS, SE_T013_001, SE_T013_002, SE_T013_003)
names(census_state)  = c("fips", "total", "white", "black")

#merge census and toxicity data
tract2010 = aggregateGeography(bg2010, "tract")
tract2010 = merge(tract2010, census_tract, by.x = "block", by.y = "fips")
county2010 = aggregateGeography(tract2010, "county")
county2010 = merge(county2010, census_county, by.x = "block", by.y = "fips")
state2010 = aggregateGeography(county2010, "state")
state2010 = merge(state2010, census_state, by.x = "block", by.y = "fips")
bg2010 = merge(bg2010, census_bg, by.x = "block", by.y = "fips")

#plot national distributions
g = ggplot() + geom_density(aes(log(bg2010$concentration), weight = bg2010$total/sum(bg2010$total), color = "Block Group"), bw = 0.05)
g = g + geom_density(aes(log(tract2010$concentration), weight = tract2010$total/sum(tract2010$total), color = "Tract"), bw = 0.05)
g = g + geom_density(aes(log(county2010$concentration), weight = county2010$total/sum(county2010$total), color = "County"), bw = 0.2)
g = g + geom_density(aes(log(state2010$concentration), weight = state2010$total/sum(state2010$total), color = "State"), bw = 0.35)
g = g + labs(x = "Log Toxicity", colour = "Geographic Level", caption = "(as assigned by different levels of geography)", title = "Distribution of Toxicity for US Population")
```



##Need to get census data for income, education, and cross tabs on race and income. 
##Need to figure out how to do a time series analysis. do I want to do a 

## I want to do a non-parametric simulation of what would have happened to the distributions if they had stayed in the same place as they were in the original distribution. 
How does the comparison there work? Do I just say wow look the real new distribution is actually significantly better, showing that there is real improvement for people of color. If we break it up by the states that implemented laws regarding environmental justice do we see a significant difference in the difference in differences? 

AKAA
Step 1) simulate the new distribution and see how the new and old dists. compare to the simulated new dist. 
Step 2) do we see that hte new is better than the simulated new?
Step 3) do we see the same "positional advancement" in the states with and without laws regarding ej?
Step 4) can we test that there is a difference in "positional advancement" (aka difference in simulated and real means)
Step 5) can we test that there is a difference in "positional advancement" for the states that have good general environmental laws?
Conclusions: there has been an improvement in the position of poc in the american toxicity distribution, and it is not/may be related to the specific ej laws.

????? what time period do I want to do that over? This is an iterational process, right? I can't just do one block of time (eg 1990 to 2010) so how do I incorporate all the jumps in time?
????? how can I do a longitudinal linear analysis? I would have a toxicity at each point, with the trend predicted by both the contents of the tract and the changes in the tract contents. 


```{r, include = FALSE}
t1990 <- read_csv("data/toxic_1990_1990_blockgroup.csv")
t1990$block = substr(t1990$block, 2, 12)
c1990 <- read_csv("data/LTDB_Std_1990_fullcount.csv")
t1990 = merge(t1990, c1990, by.x = "block", by.y = "TRTID10")
t1990$lconcentration = log(t1990$concentration)
t1990 = select(t1990, block, lconcentration, concentration, POP90, NHWHT90, NHBLK90, HISP90, OWN90, RENT90, area)
names(t1990) = c("block", "lconcentration", "concentration", "tot_pop", "white", "black", "hispanic", "owners", "renters", "area")

t2000 <- read_csv("data/toxic_2000_2000_blockgroup.csv")
t2000 = aggregateGeography(t2000, "tract")
c2000 <- read_csv("data/LTDB_Std_2000_fullcount.csv")
t2000 = merge(t2000, c2000, by.x = "block", by.y = "TRTID10")
t2000$lconcentration = log(t2000$concentration)
t2000 = select(t2000, block, lconcentration, concentration, POP00, NHWHT00, NHBLK00, HISP00, OWN00, RENT00, area)
names(t2000) = c("block", "lconcentration", "concentration", "tot_pop", "white", "black", "hispanic", "owners", "renters", "area")

t2010 <- read_csv("data/toxic_2010_2010_blockgroup.csv")
t2010 = aggregateGeography(t2010, "tract")
c2010 <- read_csv("data/LTDB_Std_2010_fullcount.csv", col_types = cols(tractid = col_character()))
c2010$tractid = str_pad(c2010$tractid, 11, pad = "0")
t2010 = merge(t2010, c2010, by.x = "block", by.y = "tractid")
t2010$lconcentration = log(t2010$concentration)
t2010 = select(t2010, block, lconcentration, concentration, pop10, nhwht10, nhblk10, hisp10, own10, rent10, area)
names(t2010) = c("block", "lconcentration", "concentration", "tot_pop", "white", "black", "hispanic", "owners", "renters", "area")
```

```{r}
vars = c("white", "black", "hispanic", "owners", "renters")
p1990 = t1990
p1990[vars] = p1990[vars]/p1990$tot_pop
p1990$density = p1990$tot_pop/p1990$area
m = lm(lconcentration ~ 1 + owners + renters + black + hispanic + density, data = p1990)

p2010 = t2010
p2010[vars] = p2010[vars]/p2010$tot_pop
p2010$density = p2010$tot_pop/p2010$area
m = lm(lconcentration ~ 1 + owners + renters + black + hispanic + density, data = p2010)
```
