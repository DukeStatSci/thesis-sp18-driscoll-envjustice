# Results {#organization}



## Toxicity trends over time

```{r quantileCalcs, echo = FALSE, message = FALSE, warning = FALSE}
library(plyr)

sim05 = fread("data/simulation05.csv", data.table = FALSE)
sim50 = fread("data/simulation50.csv", data.table = FALSE)
sim95 = fread("data/simulation95.csv", data.table = FALSE)
se_race_05 = fread("data/bootstrap_race_se_05.csv", data.table = FALSE)
se_race_50 = fread("data/bootstrap_race_se_50.csv", data.table = FALSE)
se_race_95 = fread("data/bootstrap_race_se_95.csv", data.table = FALSE)

get_perc = function(data, quant, variables = c("white", "black", "hispanic", "other"), sim = NA, se = NA) {
  new = sort(unique(data$year), decreasing = FALSE)
  for (var in variables) {
    new = cbind(new, ddply(data, .(year), function(x) weighted.quantile(x$concentration, x[, var]/sum(x[, var]), quant, na.rm = TRUE))[, 2])
  }
  new = as.data.frame(new)
  names(new) = c("year", variables)
  if (!is.na(sim)) {
    new = merge(new, sim, by = "year")
  }
  if (!is.na(se)) {
    new = merge(new, se, by = "year")
  }
  return(new)
}

perc05 = get_perc(data, 0.05, variables = names(data)[c(3:7, 10:18)])
perc50 = get_perc(data, 0.50, variables = names(data)[c(3:7, 10:18)])
perc95 = get_perc(data, 0.95, variables = names(data)[c(3:7, 10:18)])
```

```{r plottingQuantiles, echo = FALSE, message = FALSE, fig.width=8, fig.height=4}
hisp_tox = function(cur_data, perc, legend = FALSE, smooth = FALSE) {
  g = ggplot(data = cur_data) + 
  geom_line(aes(x = year, y = white, color = "white")) +
  geom_line(aes(x = year, y = black, color = "black")) + 
  geom_line(aes(x = year, y = hispanic, color = "hispanic")) + 
  geom_line(aes(x = year, y = other, color = "other")) + 
  labs(x = "Year", y = "Toxicity", title = paste0(perc, "th PCTL Group Toxicity"))
  if (legend == FALSE) {
    g = g + guides(color = FALSE)
  }
  if (smooth == TRUE) {
    g = g +
      geom_line(aes(x = year, y = rollmean(black, 3, na.pad=TRUE), color = "black"), se = FALSE, size = 0.5, linetype = "twodash")  +
      geom_line(aes(x = year, y = rollmean(hispanic, 3, na.pad = TRUE), color = "hispanic"), se = FALSE, size = 0.5, linetype = "twodash") +
      geom_line(aes(x = year, y = rollmean(other, 3, na.pad = TRUE), color = "other"), se = FALSE, size = 0.5, linetype = "twodash") +
      geom_line(aes(x = year, y = rollmean(white, 3, na.pad = TRUE), color = "white"), se = FALSE, size = 0.5, linetype = "twodash")
  }
  g
}

relative_tox = function(data, perc, legend = FALSE, smooth = FALSE) {
  g = ggplot(data) 
  if (smooth == TRUE) {
    g = g + 
      geom_line(aes(x = year, y = (white/white), color = "white")) +
      geom_line(aes(x = year, y = (black/white), color = "black"), alpha = 0.3)  +
      geom_line(aes(x = year, y = (hispanic/white), color = "hispanic"), alpha = 0.3) +
      geom_line(aes(x = year, y = (other/white), color = "other"), alpha = 0.3) +
      labs(x = "Year", y = "Toxicity Relative to White Dist.", title = paste0(perc, "th PCTL Toxicity Relative to White Distribution"), colour = "Legend") +
      theme(legend.position="bottom") +
      geom_line(aes(x = year, y = rollmean(black/white, 3, na.pad=TRUE), color = "black"), se = FALSE, size = 0.7, linetype = "twodash")  +
      geom_line(aes(x = year, y = rollmean(hispanic/white, 3, na.pad = TRUE), color = "hispanic"), se = FALSE, size = 0.7, linetype = "twodash") +
      geom_line(aes(x = year, y = rollmean(other/white, 3, na.pad = TRUE), color = "other"), se = FALSE, size = 0.7, linetype = "twodash")
  }
  else {
    g = g + 
      geom_line(aes(x = year, y = (white/white), color = "white")) +
      geom_line(aes(x = year, y = (black/white), color = "black"))  +
      geom_line(aes(x = year, y = (hispanic/white), color = "hispanic")) +
      geom_line(aes(x = year, y = (other/white), color = "other")) +
      labs(x = "Year", y = "Toxicity Relative to White Dist.", title = paste0(perc, "th PCTL Toxicity Relative to White Distribution"), colour = "Legend") +
      theme(legend.position="bottom")
  }
  if (legend == FALSE) {
    g = g + guides(color = FALSE)
  }
  g
}


pov_tox = function(cur_data, perc, legend = FALSE) {
  g = ggplot(data = cur_data) + 
  geom_line(aes(x = year, y = whiteh, color = "white")) +
  geom_line(aes(x = year, y = blackh, color = "black")) + 
  geom_line(aes(x = year, y = nativeh, color = "native")) + 
  geom_line(aes(x = year, y = asianh, color = "asian")) + 
  geom_line(aes(x = year, y = otherh, color = "other")) + 
  geom_line(aes(x = year, y = whitel, color = "white")) +
  geom_line(aes(x = year, y = blackl, color = "black")) + 
  geom_line(aes(x = year, y = nativel, color = "native")) + 
  geom_line(aes(x = year, y = asianl, color = "asian")) + 
  geom_line(aes(x = year, y = otherl, color = "other")) + 
  labs(x = "Year", y = "Group Toxicity", title = paste0(perc, "th PCTL Toxicity"), color = "Legend")
  if (legend == FALSE) {
    g = g + guides(color = FALSE)
  }
  g
}

g_legend = function(a.gplot) {
  tmp = ggplot_gtable(ggplot_build(a.gplot))
  leg = which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend = tmp$grobs[[leg]]
  return(legend)
}
```

```{r plotGroup05, echo = FALSE, fig.width=10, fig.height=4, warning = FALSE, message = FALSE}
legend_grab = relative_tox(perc05, 5, legend = TRUE)
five = hisp_tox(perc05, 5)
fifty = hisp_tox(perc50, 50)
ninetyfive = hisp_tox(perc95, 95)

five_rel = relative_tox(perc05, 5, smooth = TRUE)
fifty_rel = relative_tox(perc50, 50, smooth = TRUE)
ninetyfive_rel = relative_tox(perc95, 95, smooth = TRUE)

legend = g_legend(legend_grab)

grid.arrange(arrangeGrob(five, five_rel, nrow=1),
             legend, nrow=2,heights=c(10, 1))
```

```{r, echo = FALSE, fig.width=10, fig.height=4, warning = FALSE, message = FALSE}
grid.arrange(arrangeGrob(fifty, fifty_rel, nrow=1),
             legend, nrow=2,heights=c(10, 1))
```

```{r, echo = FALSE, fig.width=10, fig.height=4, warning = FALSE, message = FALSE}
grid.arrange(arrangeGrob(ninetyfive, ninetyfive_rel, nrow=1),
             legend, nrow=2,heights=c(10, 1))
```

## Simulating Changes

## Interacting Risk Cases

## Geographic Changes in Exposure
