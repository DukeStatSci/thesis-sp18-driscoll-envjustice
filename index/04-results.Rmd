# Results {#organization}



## Toxicity trends over time

```{r quantileCalcs, echo = FALSE, message = FALSE, warning = FALSE}
library(plyr)

sim05 = fread("data/simulation05.csv", data.table = FALSE)
sim50 = fread("data/simulation50.csv", data.table = FALSE)
sim95 = fread("data/simulation95.csv", data.table = FALSE)
se_race_05 = fread("data/bootstrap_race_se_05.csv", data.table = FALSE)
se_race_50 = fread("data/bootstrap_race_se_50.csv", data.table = FALSE)
se_race_95 = fread("data/bootstrap_race_se_95.csv", data.table = FALSE)

get_perc = function(data, quant, variables = c("white", "black", "hispanic", "other"), sim = NA, se = NA) {
  new = sort(unique(data$year), decreasing = FALSE)
  for (var in variables) {
    new = cbind(new, ddply(data, .(year), function(x) weighted.quantile(x$concentration, x[, var]/sum(x[, var]), quant, na.rm = TRUE))[, 2])
  }
  new = as.data.frame(new)
  names(new) = c("year", variables)
  if (!is.na(sim)) {
    new = merge(new, sim, by = "year")
  }
  if (!is.na(se)) {
    new = merge(new, se, by = "year")
  }
  return(new)
}

perc05 = get_perc(data, 0.05, variables = names(data)[c(3:7, 10:18)])
perc50 = get_perc(data, 0.50, variables = names(data)[c(3:7, 10:18)])
perc95 = get_perc(data, 0.95, variables = names(data)[c(3:7, 10:18)])
```

```{r plottingQuantiles, echo = FALSE, message = FALSE, fig.width=8, fig.height=4}
create_hisp_tox = function(cur_data, perc, legend = FALSE) {
  g = ggplot(data = cur_data) + 
  geom_line(aes(x = year, y = white, color = "white")) +
  geom_line(aes(x = year, y = black, color = "black")) + 
  geom_line(aes(x = year, y = hispanic, color = "hispanic")) + 
  geom_line(aes(x = year, y = other, color = "other")) + 
  labs(x = "Year", y = "Toxicity", title = paste0(perc, "th PCTL Group Toxicity"))
  if (legend == FALSE) {
    g = g + guides(color = FALSE)
  }
  g
}

create_relative_tox = function(data, perc, legend = FALSE) {
  g = ggplot(data) + 
    geom_line(aes(x = year, y = (white/white), color = "white")) +
    geom_line(aes(x = year, y = (black/white), color = "black"))  +
    geom_line(aes(x = year, y = (hispanic/white), color = "hispanic")) +
    geom_line(aes(x = year, y = (other/white), color = "other")) +
    labs(x = "Year", y = "Toxicity Relative to White Dist.", title = paste0("Group ", perc, "th Percentile Toxicity Relative to White Distribution"), colour = "Legend")
  if (legend == FALSE) {
    g = g + guides(color = FALSE)
  }
  g
}

create_pov_tox = function(cur_data, perc, legend = FALSE) {
  g = ggplot(data = cur_data) + 
  geom_line(aes(x = year, y = whiteh, color = "white")) +
  geom_line(aes(x = year, y = blackh, color = "black")) + 
  geom_line(aes(x = year, y = nativeh, color = "native")) + 
  geom_line(aes(x = year, y = asianh, color = "asian")) + 
  geom_line(aes(x = year, y = otherh, color = "other")) + 
  geom_line(aes(x = year, y = whitel, color = "white")) +
  geom_line(aes(x = year, y = blackl, color = "black")) + 
  geom_line(aes(x = year, y = nativel, color = "native")) + 
  geom_line(aes(x = year, y = asianl, color = "asian")) + 
  geom_line(aes(x = year, y = otherl, color = "other")) + 
  labs(x = "Year", y = "Group Toxicity", title = paste0(perc, "th PCTL Toxicity"), color = "Legend")
  if (legend == FALSE) {
    g = g + guides(color = FALSE)
  }
  g
}
```

```{r plotGroup05, echo = FALSE, fig.width=10, fig.height=4}
five = create_hisp_tox(perc05, 5)
fifty = create_hisp_tox(perc50, 50)
ninetyfive = create_hisp_tox(perc95, 95)
grid.arrange(five, fifty, ninetyfive, ncol=3)

five = create_relative_tox(perc05, 5)
fifty = create_relative_tox(perc50, 50)
ninetyfive = create_relative_tox(perc95, 95)
grid.arrange(five, fifty, ninetyfive, ncol=3)
```


create_relative_tox(perc05, 5)
create_relative_tox(perc50, 50)
create_relative_tox(perc95, 95)

create_pov_tox(perc_pov_05, 5)
create_pov_tox(perc_pov_50, 50)
create_pov_tox(perc_pov_95, 95)
