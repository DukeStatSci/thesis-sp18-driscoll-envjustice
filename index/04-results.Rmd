# Results {#organization}

## Toxicity Trends

Spurred by fear created by a disaster release of toxic chemicals in India, the Community Right to Know Act was created in 1986 to enforce reporting on hazardous chemicals being realeased in to the environment by individual facilities. TRI data, beginning in 1988, is the public release of the data created through the Community Right to Know Act.

The time after TRI began collection included a lot of environmental regulation, including the Montreal Protol, the Clean Air Act Amendments of 1990, the Oil Pollution Act of 1990 and the 1994 Executive Order directing 'federal agiencies to identify and address the disproportionately high ... environmental effects ... on minority populations.' (Executive Order, 1994) As more and more environmental protections went in to place and collective environmental attitudes became greener, we expect to see large drops in toxicity experienced by all groups. The early 1990's enforced mandated phase outs of certain CFC's and requirements for facilities to switch to Best Available Control Technology (BACT), so there should be large drops in toxicity.


```{r alltoxicity, echo = FALSE, fig.width=7, fig.height=4}
pounds = fread("data/release_trends.csv", data.table = FALSE)[1:26, ]

ggplot(pounds) + geom_line(aes(x = as.double(year), y = as.double(tox))) + 
#  scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
#                labels = scales::trans_format("log10", scales::math_format(10^.x))) +
#  annotation_logticks(short = unit(1,"mm"), mid = unit(2.2,"mm"), long = unit(3.5,"mm"), sides = "l", color = "gray65") +
  labs(x = "Year", y = "Pounds of TRI Chemicals Released", title = "TRI releases by weight over time") +
  theme(plot.title = element_text(hjust = 0.5))
```

Looking at the net volume of TRI releases, we do see a fairly linear drop in the pounds of TRI chemicals being released nationally between 1988 and 2013. Despite the common use of volume of TRI releases as a study measure (SOURCES) the rest of this work proceeds to use TRI toxicity as the measure of interest. TRI toxicity refers to the weight of each release multiplied by the toxicity weight assigned to the chemical by the EPA. Given that TRI chemicals vary significantly in their potential human effects, toxicity experienced is a better measure of the potential human impact than the net weight of toxic chemicals experienced. Given that this seeks to find differences in pollution experienced by minority groups, toxicicty is even more important, as there is potential that more toxic releases are focused in minority communities, which would not be evident by net weight.

Toxicity trends look very different than the net release trends shown above. This is partially attributable to the strongly skewed distribution of toxicity. As some releases are of extremely toxic chemicals, the distribution of toxicities experienced is extremely right skewed by toxic dumps. 

```{r, echo = FALSE, fig.width=7, fig.height=4}
ggplot(data[data$year == 2000,]) + geom_density(aes(concentration, weight = pop/sum(pop)), fill = "pink", color = "pink", alpha = 0.7) +
  labs(x = "Toxicity", y = "Density", title = "Toxicities experienced in 2000") +
  theme(plot.title = element_text(hjust = 0.5))
```


Given the extremely right skewed nature of this distribution, for ease of analysis and interpretation, from here on toxicity is reported as log toxicity. The distributions of log toxicity are much more interpretable, but care must be used to contextualize the results. 

```{r, echo = FALSE, fig.width=7, fig.height=4}
ggplot(data[data$year == 2000,]) + geom_density(aes(concentration, weight = pop/sum(pop)), fill = "pink", color = "pink", alpha = 0.6) +
  labs(x = "Log Toxicity", y = "Density", title = "Log Toxicities experienced in 2000") +
  theme(plot.title = element_text(hjust = 0.5)) + 
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  annotation_logticks(short = unit(1,"mm"), mid = unit(2.2,"mm"), long = unit(3.5,"mm"), sides = "b", color = "gray65")
```

In this application, there are locations that are orders of magnitude more toxic than the bulk of the United States. These are sites to be aware of, where toxicity is more likely to have an effect on people's lives or health. As discussed in the data section, toxicity measures don't necessarily align with the locations that we know are truly hazardous. 

Many of the locations that arise as especially toxic in the data are assuredly so. High Point, NC is consistently one of the most toxic tracts in the early 2000's, as confirmed by [EPA reports](https://cfpub.epa.gov/si/si_public_record_Report.cfm?dirEntryID=45198) identifying it as a location prime for testing toxicity abatement measures. Tracts outside of Salt Lake City commonly known for acting as [dumping grounds](http://www.nytimes.com/2002/10/20/us/utah-county-s-toxic-tradition-is-under-threat.html) are consistently ranked as toxic in the early 2000's. Mobile, AL, whose [3 superfund sites](https://19january2017snapshot.epa.gov/enforcement/case-summary-epa-funded-sites-and-communities-chemtura-bankruptcy-settlements_.html#stauffer) were proposed in the early 1990's, routinely ranks as toxic over that time period. 

On the other side of the coin, there are many known toxic events and locations that fail to ever reach the top 5% of toxic tracts, of which Flint, MI, and the Houston major superfund site are good examples.

## Geography of Toxicity Trends

Toxic exposure has been changing dramatically in the US, but the trends it follows have remained similar. In the gif below, we show toxicity across the US from 2010 to 2014. 

\begin{center}
![GIF of toxicity in America from 2010 to 2014.](https://raw.githubusercontent.com/DukeStatSci/thesis-sp18-driscoll-envjustice/master/index/figure/usa_slow2.gif)
\end{center}

Though we see impressive reductions over that time, the overall geographic trends of toxicity remain constant. Each region maintains its overall toxicity range, and toxicity wells appear to stay constant. Given the infrastructure required to build up manufacturing, a large part of TRI, the consistency across time is reasonable. 

The toxicity wells we see in the image are familiar, as many of them occur around large cities, where there is likely to be industry. Though many large cities stand out as having high toxicity, there's not a one to one correlation between areas of high toxicity and population density. As an example, in Texas, Houston and San Antonio have high toxicity values, while the Dallas/Fort has fairly low toxictiy. Comparatively, the more rural areas of Longview and Tyler are very high toxicity. 

Regions that stand out the most include the northern border of Kentucky, the regions surrounding Chicago, the border between New Jersey and Pennsylvania, and the westernmost section of the gulf coast.

A closer view of the Texan region of h

## Trends in Minority Toxicity Burden

Using data at the tract level, we assign the tract concentration to the counts of each group in the tract. By assigning toxicity for each tract, we build four distributions: toxicity for the white population, toxicity for the black population, toxicity for the hispanic population, and toxicity for all other groups. In this case, hispanic is not a mutually exclusive group, and the race groups may contain ethnically hispanic individuals. 

For each of the distributions, the 5th, 50th, and 95th percentiles are calculated for each time period. In the case of toxicity, the 5th and 95th percentiles are especially of interest, as they represent the non-polluted neighborhoods that each group has access to and the level of pollution trap that each group falls in to. Clearly, for all variables, lower toxicity is better. 

Plots describing the trends for each quantile are shown below. On the left is the log toxicity for the quantile over time. On the right is the toxicity minorities experience relative to the white distribution. These values are computed as the net toxicity of the given quantile for a group divided by the net toxicity of the quantile for the white distribution.


```{r quantileCalcs, echo = FALSE, message = FALSE, warning = FALSE}
library(plyr)

sim05 = fread("data/simulation05.csv", data.table = FALSE)
sim50 = fread("data/simulation50.csv", data.table = FALSE)
sim95 = fread("data/simulation95.csv", data.table = FALSE)
se_race_05 = fread("data/bootstrap_race_se_05.csv", data.table = FALSE)
se_race_50 = fread("data/bootstrap_race_se_50.csv", data.table = FALSE)
se_race_95 = fread("data/bootstrap_race_se_95.csv", data.table = FALSE)

get_perc = function(data, quant, variables = c("white", "black", "hispanic", "other"), sim = NA, se = NA) {
  new = sort(unique(data$year), decreasing = FALSE)
  for (var in variables) {
    new = cbind(new, ddply(data, .(year), function(x) weighted.quantile(x$concentration, x[, var]/sum(x[, var]), quant, na.rm = TRUE))[, 2])
  }
  new = as.data.frame(new)
  names(new) = c("year", variables)
  if (!is.na(sim)) {
    new = merge(new, sim, by = "year")
  }
  if (!is.na(se)) {
    new = merge(new, se, by = "year")
  }
  return(new)
}

perc05 = get_perc(data, 0.05, variables = names(data)[c(3:7, 10:18)], sim = sim05)
perc50 = get_perc(data, 0.50, variables = names(data)[c(3:7, 10:18)], sim = sim50)
perc95 = get_perc(data, 0.95, variables = names(data)[c(3:7, 10:18)], sim = sim95)

msa_perc05 = get_perc(dense_data, 0.05, variables = names(data)[c(3:7, 10:18)], sim = sim05)
msa_perc50 = get_perc(dense_data, 0.50, variables = names(data)[c(3:7, 10:18)], sim = sim50)
msa_perc95 = get_perc(dense_data, 0.95, variables = names(data)[c(3:7, 10:18)], sim = sim95)
```

```{r createPlots, echo = FALSE, message = FALSE, fig.width=8, fig.height=4}
tox = function(cur_data, perc, legend = FALSE, smooth = FALSE, log = TRUE) {
  g = ggplot(data = cur_data) + 
  geom_line(aes(x = year, y = white, color = "white")) +
  geom_line(aes(x = year, y = black, color = "black")) + 
  geom_line(aes(x = year, y = hispanic, color = "hispanic")) + 
  geom_line(aes(x = year, y = other, color = "other")) + 
  labs(x = "Year", y = "Toxicity", title = paste0(perc, "th PCTL Group Toxicity")) +
  theme(plot.title = element_text(hjust = 0.5))
  if (legend == FALSE) {
    g = g + guides(color = FALSE)
  }
  if (smooth == TRUE) {
    g = g +
      geom_line(aes(x = year, y = rollmean(black, 3, na.pad=TRUE), color = "black"), se = FALSE, size = 0.5, linetype = "twodash")  +
      geom_line(aes(x = year, y = rollmean(hispanic, 3, na.pad = TRUE), color = "hispanic"), se = FALSE, size = 0.5, linetype = "twodash") +
      geom_line(aes(x = year, y = rollmean(other, 3, na.pad = TRUE), color = "other"), se = FALSE, size = 0.5, linetype = "twodash") +
      geom_line(aes(x = year, y = rollmean(white, 3, na.pad = TRUE), color = "white"), se = FALSE, size = 0.5, linetype = "twodash")
  }
  if (log == TRUE) {
    g = g + scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                          labels = scales::trans_format("log10", scales::math_format(10^.x))) +
      annotation_logticks(
        short = unit(.5,"mm"),
        mid = unit(2,"mm"), 
        long = unit(3.5,"mm"),
        sides = "l",
        color = "gray65") 
  }
  g
}

relative_tox = function(data, perc, legend = FALSE, smooth = FALSE) {
  g = ggplot(data) +
    labs(x = "Year", y = "Toxicity Relative to White Dist.", title = paste0(perc, "th PCTL Toxicity Relative to White Distribution"), colour = "Legend") +
    theme(plot.title = element_text(hjust = 0.5))
  if (smooth == TRUE) {
    g = g + 
      geom_line(aes(x = year, y = (white/white), color = "white")) +
      geom_line(aes(x = year, y = (black/white), color = "black"), alpha = 0.3)  +
      geom_line(aes(x = year, y = (hispanic/white), color = "hispanic"), alpha = 0.3) +
      geom_line(aes(x = year, y = (other/white), color = "other"), alpha = 0.3) +
      geom_line(aes(x = year, y = rollmean(black/white, 3, na.pad=TRUE), color = "black"), linetype = "twodash", size = 0.7)  +
      geom_line(aes(x = year, y = rollmean(hispanic/white, 3, na.pad = TRUE), color = "hispanic"), linetype = "twodash", size = 0.7) +
      geom_line(aes(x = year, y = rollmean(other/white, 3, na.pad = TRUE), color = "other"), linetype = "twodash", size = 0.7) +
      theme(legend.position="bottom")
  }
  else {
    g = g + 
      geom_line(aes(x = year, y = (white/white), color = "white")) +
      geom_line(aes(x = year, y = (black/white), color = "black"))  +
      geom_line(aes(x = year, y = (hispanic/white), color = "hispanic")) +
      geom_line(aes(x = year, y = (other/white), color = "other")) +
      theme(legend.position="bottom")
  }
  if (legend == FALSE) {
    g = g + guides(color = FALSE)
  }
  g
}

pov_tox = function(cur_data, perc, legend = FALSE) {
  g = ggplot(data = cur_data) + 
    geom_line(aes(x = year, y = whiteh, color = "white")) +
    geom_line(aes(x = year, y = blackh, color = "black")) + 
    geom_line(aes(x = year, y = nativeh, color = "native")) + 
    geom_line(aes(x = year, y = asianh, color = "asian")) + 
    geom_line(aes(x = year, y = otherh, color = "other")) + 
    geom_line(aes(x = year, y = whitel, color = "white")) +
    geom_line(aes(x = year, y = blackl, color = "black")) + 
    geom_line(aes(x = year, y = nativel, color = "native")) + 
    geom_line(aes(x = year, y = asianl, color = "asian")) + 
    geom_line(aes(x = year, y = otherl, color = "other")) + 
    labs(x = "Year", y = "Group Toxicity", title = paste0(perc, "th PCTL Toxicity"), color = "Legend") +
    theme(plot.title = element_text(hjust = 0.5))
  if (legend == FALSE) {
    g = g + guides(color = FALSE)
  }
  g
}

g_legend = function(a.gplot) {
  tmp = ggplot_gtable(ggplot_build(a.gplot))
  leg = which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend = tmp$grobs[[leg]]
  return(legend)
}
```

```{r plottox05, echo = FALSE, fig.width=10, fig.height=4, warning = FALSE, message = FALSE}
five = tox(perc05, 5)
fifty = tox(perc50, 50)
ninetyfive = tox(perc95, 95)

five_rel = relative_tox(perc05, 5, smooth = TRUE)
fifty_rel = relative_tox(perc50, 50, smooth = TRUE)
ninetyfive_rel = relative_tox(perc95, 95, smooth = TRUE)

legend_grab = relative_tox(perc05, 5, legend = TRUE)
color_legend = g_legend(legend_grab)

grid.arrange(arrangeGrob(five, five_rel, nrow=1),
             color_legend, nrow=2,heights=c(10, 1))
```

As we see in the 5th percentile plots, the 5th percentile of experienced toxicity is steadily decreasing for all groups. Given the y axis has been logged, and we see a linear trend, toxicity has seen an exponential drop over the years. There appear to be two distinct groups, with the black and 'other' groups significantly higher than the white and hispanic groups in 1988, and even moredistinctly seperated by 2013. Though we see incredible improvements in toxicity for all groups, the relative improvement shows a different story. The difference for the 'other' minorities is most impressive, originally having 5th percentile toxicity at approximately 1.5 times the rate of the white 5th percentile, but ending at over 6 times the white 5th percentile. 

From this plot we see that though minorities have had the largest net decreases in 5th percentile toxicity, those gains are an artifact of how much higher their toxicity began at. When framing improvements relative to the white population, there has been no improvement, in some cases relative toxicity has regressed.

```{r plottox50, echo = FALSE, fig.width=10, fig.height=4, warning = FALSE, message = FALSE}
grid.arrange(arrangeGrob(fifty, fifty_rel, nrow=1),
             color_legend, nrow=2,heights=c(10, 1))
```

The toxicity changes for the 50th percentile tell a very different story. Again, we see linear improvement in the logged toxicity plot, indicating an exponential decrease in the toxicity experienced by the 50th percentile of the population. The difference at the 50th percentile is that minority groups have improved faster than their white counterparts, meaning that the relative toxicity of all groups is converging towards the 50th percentile of the white distribution. 

```{r plottox95, echo = FALSE, fig.width=10, fig.height=4, warning = FALSE, message = FALSE}
grid.arrange(arrangeGrob(ninetyfive, ninetyfive_rel, nrow=1),
             color_legend, nrow=2,heights=c(10, 1))
```

Ninety-fifth percentile toxicity is in some ways the most of interest. The difference between estimates for white and minorities is approximately an order of magnitude at the 5th, 50th, and 95th percentile, but at this level an order of magnitude is a much larger difference than in the 5th percentile. An interesting difference is that at the high end of the distribution, we see the 'other' minority group has a relative toxicity close to 1, where in previous plots the other group had significantly worse relative toxicity. Similarly, though the hispanic group previously performed closest to the white group, at the 95th percentile the hispanic group performs more similarly to the black distribution. 

Examining the changes in each of these plots independently gives us a glimpse at how the distributions as a whole are shifting. The lack of change, or even worsening, of relative toxicity for the black and other distributions at the 5th percentile may be indicative of barriers minorities face in access to clean communities. As wealthier communities are getting ever cleaner, minorities are still unable to gain access to them, meaning less improvement in the low tail of the minority distributions. 

Comparatively, the changes at the 50th percentile show that minorities have all consistently improved faster than the white 50th percentile, meaning that the bulk of the distribution has been shifting faster than the white distribution. 

In the 95th percentile, we see the hispanic group performing similarly to the white distribution, while the black and hispanic distributions improve until the early 2000's, and then flatten out or rise relative to the white distribution. With the widening gap in the 5th percentile, the closing gap in the 50th percentile, and the stagnation of change in the 95th, we see that the distribution is shifting left and condensing as the left tail stagnates, and the right tail slowly moves in. 

In essense we are seeing the "rich getting richer" phenomenon in the 5th percentile of the white distribution. Those that already have access to clean communities are seeing improved toxicity, with those who weren't already in clean communities unable to catch up, and locked out of the lowest toxicity communities. 

## Simulating Changes

Being able to build the true distributions that each group experiences over time allows us to see how relative toxicity burden has changed over time. Yet the changes presented in the analysis above are solely the net changes experienced by each group. Given minorities are more likely to be in the right tail of the distribution, any compression of that tail would result in both a net improvement for minority groups and a relative improvement to the white distribution. Those changes, though positive, don't represent a true change in the position minorities hold in the distribution, as they are still stuck in the percentile of the distribution, but the distribution has shifted favorably. 

To find how much of the change is attributable to changes of minority position, we use the simulation method discussed in section 3. By holding the percentile of each individual constant, but applying it to the new distribution, we can see what the minority distribution would like if the minority position within the overall distribution had not changed. 

Improvement will only represent true environmental justice when all groups are equally likely to be represented at any given quantile, not when the distribution is compressed enough that differences are negligible. 


```{r changePlots, echo = FALSE, warning = FALSE, fig.width=10, fig.height=4}
sim_tox = function(cur_data, perc, legend = FALSE, smooth = FALSE, log = TRUE) {
  g = ggplot(data = cur_data) + 
        labs(x = "Year", y = "Toxicity", title = paste0(perc, "th PCTL Group Toxicity")) +
        theme(plot.title = element_text(hjust = 0.5))
  if (smooth == TRUE) {
    g = g +
      geom_line(aes(x = year, y = white, color = "white"), alpha = 0.3) +
      geom_line(aes(x = year, y = black, color = "black"), alpha = 0.3) + 
      geom_line(aes(x = year, y = hispanic, color = "hispanic"), alpha = 0.3) + 
      geom_line(aes(x = year, y = other, color = "other"), alpha = 0.3) + 
      geom_line(aes(x = year, y = rollmean(black, 3, na.pad=TRUE), color = "black"), size = 0.5)  +
      geom_line(aes(x = year, y = rollmean(hispanic, 3, na.pad = TRUE), color = "hispanic"), size = 0.5) +
      geom_line(aes(x = year, y = rollmean(other, 3, na.pad = TRUE), color = "other"), size = 0.5) +
      geom_line(aes(x = year, y = rollmean(white, 3, na.pad = TRUE), color = "white"), size = 0.5)
  } 
  else {
     g = g +
      geom_line(aes(x = year, y = white, color = "white")) +
      geom_line(aes(x = year, y = black, color = "black")) + 
      geom_line(aes(x = year, y = hispanic, color = "hispanic")) + 
      geom_line(aes(x = year, y = other, color = "other"))
  }
  g = g + geom_line(aes(x = year, y = sim_b, color = "black"), linetype = "dashed", size = 0.7) + 
    geom_line(aes(x = year, y = sim_o, color = "other"), linetype = "dashed", size = 0.7) +
    geom_line(aes(x = year, y = sim_h, color = "hispanic"), linetype = "dashed", size = 0.7) 
  if (legend == FALSE) {
    g = g + guides(color = FALSE)
  }
  if (log == TRUE) {
    g = g + scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                          labels = scales::trans_format("log10", scales::math_format(10^.x))) +
      annotation_logticks(
        short = unit(.5,"mm"),
        mid = unit(2,"mm"), 
        long = unit(3.5,"mm"),
        sides = "l",
        color = "gray65") 
  }
  g
}

relative_sim = function(data, perc, legend = FALSE, smooth = FALSE) {
  g = ggplot(data) +
    labs(x = "Year", y = "Toxicity Relative to White Dist.", title = paste0(perc, "th PCTL Toxicity Relative to White Distribution"), colour = "Legend") +
    theme(plot.title = element_text(hjust = 0.5)) + 
    theme(legend.position="bottom") +
    geom_line(aes(x = year, y = (white/white), color = "white")) 
  if (smooth == TRUE) {
    g = g + 
      geom_line(aes(x = year, y = (black/white), color = "black"), alpha = 0.2)  +
      geom_line(aes(x = year, y = (hispanic/white), color = "hispanic"), alpha = 0.2) +
      geom_line(aes(x = year, y = (other/white), color = "other"), alpha = 0.2) +
      geom_line(aes(x = year, y = rollmean(black/white, 3, na.pad=TRUE), color = "black"), size = 0.7, alpha = 0.45)  +
      geom_line(aes(x = year, y = rollmean(hispanic/white, 3, na.pad = TRUE), color = "hispanic"), size = 0.7, alpha = 0.45) +
      geom_line(aes(x = year, y = rollmean(other/white, 3, na.pad = TRUE), color = "other"), size = 0.7, alpha = 0.45) +
      geom_line(aes(x = year, y = rollmean(sim_b/white, 3, na.pad = TRUE), color = "black"), linetype = "dashed", size = 0.7) + 
      geom_line(aes(x = year, y = rollmean(sim_o/white, 3, na.pad = TRUE), color = "other"), linetype = "dashed", size = 0.7) +
      geom_line(aes(x = year, y = rollmean(sim_h/white, 3, na.pad = TRUE), color = "hispanic"), linetype = "dashed", size = 0.7) 
  } else {
    g = g + 
      geom_line(aes(x = year, y = (black/white), color = "black"), alpha = 0.45)  +
      geom_line(aes(x = year, y = (hispanic/white), color = "hispanic"), alpha = 0.45) +
      geom_line(aes(x = year, y = (other/white), color = "other"), alpha = 0.45) +
      geom_line(aes(x = year, y = sim_b/white, color = "black"), linetype = "dashed", size = 0.7) + 
      geom_line(aes(x = year, y = sim_o/white, color = "other"), linetype = "dashed", size = 0.7) +
      geom_line(aes(x = year, y = sim_h/white, color = "hispanic"), linetype = "dashed", size = 0.7) 
  }
  if (legend == FALSE) {
    g = g + guides(color = FALSE)
  }
  g
}
```

```{r, echo = FALSE, fig.width=10, fig.height=4, warning = FALSE}
grid.arrange(arrangeGrob(sim_tox(perc05, 5), relative_sim(perc05, 5), nrow=1),
             color_legend, nrow=2,heights=c(10, 1))
```

The 5th percentile of the simulated black distribution is significantly higher than that of the true black distribution, rising to approximately 12 times that of the white distribution. This means that more black individuals were able to move to locations with lower toxicity or had dramatic improvements in neighborhood toxicity. If they had maintained their location in the overall distribution, they would have experienced significantly higher toxicities. Interestingly, the opposite is true for the 'other' distribution. Their true 5th percentile has significantly worse toxicity than their simulated 5th percentile. This indicates that non-black minorities at the low end of the distribution have worse places in the overall distribution than they did in 1990. 

```{r, echo = FALSE, fig.width=10, fig.height=4, warning = FALSE}
grid.arrange(arrangeGrob(sim_tox(perc50, 50), relative_sim(perc50, 50), nrow=1),
             color_legend, nrow=2,heights=c(10, 1))
```

Changes at the 50th percentile were much more impressive in the initial analysis, and remain that way. The simulated distributions still show improvement, but very minor compared to the observed improvement. The simulated black 50th percentile drops from 3 times to 2.75 times the white 50th percentile, where the true distribution drops from 3 times to 1.5 times the white distribution. All the simulations show the same pattern, with the hispanic group showing the largest difference between true and simulated 50th percentile, the simulated group ending at 2.25 times the white distribution, and the true group ending at 0.75 times the white distribution. 

Interpreting these changes as the portion of change attributable to true change in where each group stands in the distribution, it seems that there has been significant change in the positions minorities hold in the overall toxicity distribution.

```{r, echo = FALSE, fig.width=10, fig.height=4, warning = FALSE}
grid.arrange(arrangeGrob(sim_tox(perc95, 95), relative_sim(perc95, 95), nrow=1),
             color_legend, nrow=2,heights=c(10, 1))
```

Simulations of the 95th percentile show even less improvement, meaning nearly all the change minorities experience is from moving towards a lower quantile in the overall distribution. At the 95th percentile the black distribution shows the largest difference to it's simulated distribution. The simulated black 95th percentile ends at 2.25 times that of the white distribution, while the 95th percentile of the true distribution ends at 1.75 times that of the white distribution. 

From this we see that the distribution of quantiles occupied by minority groups was originally shifted towards the higher quantiles, but over time have shifted right. Plotting the percentiles of each group within their full distribution that year, we see that in 1990 all minority groups are strongly skewed towards the higher end of the distribution. As time goes on, more minorities exist in the lower percentiles, and more whites exist in the higher percentiles of the distribution.

```{r densityplots, warning = FALSE,echo = FALSE, fig.width=10, fig.height=4, message = FALSE}
quants = read_csv("data/quantiles.csv")
p2013 = ggplot(quants) + 
  geom_density(aes(black2013, fill = "black", color = "black"), alpha = 0.05) + 
  geom_density(aes(white2013, fill = "white", color = "white"), alpha = 0.05) + 
  geom_density(aes(other2013, fill = "other", color = "other"), alpha = 0.05) + 
  geom_density(aes(hispanic2013, fill = "hisp", color = "hisp"), alpha = 0.05) + 
  labs(x = "Percentile in 2013", y = "Density") +
  guides(color = FALSE, fill = FALSE)
p1990 = ggplot(quants) + 
  geom_density(aes(black1990, fill = "black", color = "black"), alpha = 0.05) + 
  geom_density(aes(white1990, fill = "white", color = "white"), alpha = 0.05) + 
  geom_density(aes(other1990, fill = "other", color = "other"), alpha = 0.05) + 
  geom_density(aes(hispanic1990, fill = "hisp", color = "hisp"), alpha = 0.05) + 
  labs(x = "Percentile in 1990", y = "Density") +
  guides(color = FALSE, fill = FALSE)
p2000 = ggplot(quants) + 
  geom_density(aes(black2000, fill = "black", color = "black"), alpha = 0.05) + 
  geom_density(aes(white2000, fill = "white", color = "white"), alpha = 0.05) + 
  geom_density(aes(other2000, fill = "other", color = "other"), alpha = 0.05) + 
  geom_density(aes(hispanic2000, fill = "hisp", color = "hisp"), alpha = 0.05) + 
  labs(x = "Percentile in 2000", y = "Density") +
  guides(color = FALSE, fill = FALSE)

grid.arrange(arrangeGrob(p1990, p2000, p2013, nrow=1),
             color_legend, nrow=2,heights=c(10, 1))
```


## Interacting Risk Cases
```{r incPlots, include = FALSE, warning = FALSE, fig.width=10, fig.height=4}
ggplot(perc50) + 
  geom_ribbon(aes(x = year, ymax = log(blackh), ymin = log(blackl), fill = "black"), alpha = 0.3) + 
  geom_line(aes(x = year, y = log(blackh), fill = "black"), alpha = 0.3) + 
  geom_line(aes(x = year, y = log(whiteh), fill = "white"), alpha = 0.3) + 
  geom_line(aes(x = year, y = log(hisph), fill = "white"), alpha = 0.3) + 
  geom_ribbon(aes(x = year, ymax = log(whiteh), ymin = log(whitel), fill = "white"), alpha = 0.3) + 
  geom_ribbon(aes(x = year, ymax = log(hisph), ymin = log(hispl), fill = "hispanic"), alpha = 0.3)

ggplot(perc50) + 
  geom_ribbon(aes(x = year, ymax = blackh, ymin = blackl, fill = "black"), alpha = 0.3) + 
  geom_line(aes(x = year, y = blackh, fill = "black"), alpha = 0.3) + 
  geom_line(aes(x = year, y = whiteh, fill = "white"), alpha = 0.3) + 
  geom_line(aes(x = year, y = hisph, fill = "white"), alpha = 0.3) + 
  geom_ribbon(aes(x = year, ymax = whiteh, ymin = whitel, fill = "white"), alpha = 0.3) + 
  geom_ribbon(aes(x = year, ymax = hisph, ymin = hispl, fill = "hispanic"), alpha = 0.3)
```


## Quantile Regression

Previous sections have focused on teasing apart patterns in the vast amounts of data we have, attempting to find differences in toxicity experienced by minority groups. We find large differences in the toxicity experienced, but may be limited by the choices in division we make. Given we only investigate the variables that we suspect may have a relationship with toxicity, there are likley patterns in teh data that aren't being examined. 

In order to better tease out relationships in the data, and for easy interpretation of coefficients, a functionally similar analysis can be done with quantile regression, focusing on the computed parameters as indicators of the differences in experienced toxicity. 

To illustrate the form of model this could take, we build preliminary quantile regression models on the 5th, 50th, and 95th percentiles of the toxicity distribution. To predict log toxicity, we use the year, demographic information, population density as well as quadratic terms. The predictions shown for each race or ethnicity group are fairly consistent with the results shown above. 
```{r quantreg, echo = FALSE}
sample = sample_frac(data, size = 0.08)
sample$p_white = sample$white/sample$pop
sample$p_black = sample$black/sample$pop
sample$p_hispanic = sample$hispanic/sample$pop
sample$p_other = sample$other/sample$pop


quant = rq(log(concentration)~year+year*(p_white+p_black+p_hispanic+p_other+density)+I(year^2)*(p_white+p_black+p_hispanic+p_other+density), 
           tau = c(0.05, 0.5, 0.95), data = sample)
quant_lin = rq(log(concentration)~year+year*(p_white+p_black+p_hispanic+p_other+density), tau = c(0.05, 0.5, 0.95), data = sample)
quant_tri = rq(log(concentration)~year+I(year^2)*(p_white+p_black+p_hispanic+p_other+density)+I(year^3)*(p_white+p_black+p_hispanic+p_other+density), tau = c(0.05, 0.5, 0.95), data = sample)
quant_den = rq(log(concentration)~year+I(year^2)*(p_white+p_black+p_hispanic+p_other+density)+density*(p_white+p_black+p_hispanic+p_other+density), tau = c(0.05, 0.5, 0.95), data = sample)
quant_tri_den = rq(log(concentration)~year+I(year^2)*(p_white+p_black+p_hispanic+p_other+density)+I(year^3)*(p_white+p_black+p_hispanic+p_other+density)+density*(p_white+p_black+p_hispanic+p_other+density), tau = c(0.05, 0.5, 0.95), data = sample)

test = data.frame(year = rep(seq(1990, 2013), 4), 
                  p_white = c(rep(1, 24), rep(0, 72)), 
                  p_black = c(rep(0, 24), rep(1, 24), rep(0, 48)), 
                  p_hispanic = c(rep(0, 48), rep(1, 24), rep(0, 24)), 
                  p_other =c(rep(0, 72), rep(1, 24)), 
                  density = rep(10, 96))

plot_quant = function(pred) {
  min = min(pred)
  max = max(pred)
  years = seq(1990, 2013)
  five = ggplot() + geom_line(aes(x = years, pred[1:24, 1], color = "white")) +
  geom_line(aes(x = years, pred[25:48, 1], color = "black")) +
  geom_line(aes(x = years, pred[49:72, 1], color = "hispanic")) +
  geom_line(aes(x = years, pred[73:96, 1], color = "other")) +
  labs(x = "Years", y = "Concentration") +
  scale_y_log10(limits = c(min, max), breaks = scales::trans_breaks("log10", function(x) 10^x), 
                labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  annotation_logticks(short = unit(.5,"mm"), mid = unit(2,"mm"),  
                      long = unit(3.5,"mm"), sides = "l", color = "gray65") +
  guides(color = FALSE)
  
  fifty = ggplot() + geom_line(aes(x = years, pred[1:24, 2], color = "white")) +
  geom_line(aes(x = years, pred[25:48, 2], color = "black")) +
  geom_line(aes(x = years, pred[49:72, 2], color = "hispanic")) +
  geom_line(aes(x = years, pred[73:96, 2], color = "other")) +
  labs(x = "Years", y = "Concentration") + 
  scale_y_log10(limits = c(min, max), breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  annotation_logticks(short = unit(.5,"mm"), mid = unit(2,"mm"),  
                      long = unit(3.5,"mm"), sides = "l", color = "gray65") +
  guides(color = FALSE)
  
  ninety = ggplot() + geom_line(aes(x = years, pred[1:24, 3], color = "white")) +
  geom_line(aes(x = years, pred[25:48, 3], color = "black")) +
  geom_line(aes(x = years, pred[49:72, 3], color = "hispanic")) +
  geom_line(aes(x = years, pred[73:96, 3], color = "other")) +
  labs(x = "Years", y = "Concentration") +  
  scale_y_log10(limits = c(min, max), breaks = scales::trans_breaks("log10", function(x) 10^x), 
                labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  annotation_logticks(short = unit(.5,"mm"), mid = unit(2,"mm"),  
                      long = unit(3.5,"mm"), sides = "l", color = "gray65") +
  guides(color = FALSE)
  
  grid.arrange(arrangeGrob(five, fifty, ninety, nrow=1))
} 

plot_quant(exp(predict.rq(quant_den, test)))
```

By adding additional block level data to this regression and testing model fit more rigorously, we may be able to discuss the magnitude of toxicity differences that are attributable to race, and will be more informed on the other factors that hold importance in predicting toxicity. Above sections address the empirical reduction in toxicity and the reduction amount attributable to shifts of minority placement in the distribution. An approach able to take it a step further and find the differences attributable to race would add significant value. 